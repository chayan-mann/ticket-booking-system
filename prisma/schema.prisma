generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  createdAt DateTime @default(now())

  bookings  Booking[]
  payments  Payment[]
  seatHolds SeatHold[]
}

model Movie {
  id          String   @id @default(uuid())
  title       String
  durationMin Int
  createdAt   DateTime @default(now())

  shows Show[]
}

model Theatre {
  id        String   @id @default(uuid())
  name      String
  city      String
  createdAt DateTime @default(now())

  screens Screen[]
}

model Screen {
  id        String   @id @default(uuid())
  name      String
  theatreId String
  capacity  Int
  createdAt DateTime @default(now())

  theatre Theatre @relation(fields: [theatreId], references: [id])
  seats   Seat[]
  shows   Show[]

  @@unique([theatreId, name])
}

/// SEAT LAYOUT  ///

model Seat {
  id        String   @id @default(uuid())
  screenId  String
  row       String
  number    Int
  createdAt DateTime @default(now())

  screen    Screen     @relation(fields: [screenId], references: [id])
  showSeats ShowSeat[]

  @@unique([screenId, row, number])
}

/// SHOWS        ///

model Show {
  id        String   @id @default(uuid())
  movieId   String
  screenId  String
  startTime DateTime
  createdAt DateTime @default(now())

  movie  Movie  @relation(fields: [movieId], references: [id])
  screen Screen @relation(fields: [screenId], references: [id])

  showSeats ShowSeat[]
  bookings  Booking[]

  @@unique([screenId, startTime])
  @@index([startTime])
}

////////////////////
/// SHOW SEATS   ///
////////////////////

model ShowSeat {
  id     String   @id @default(uuid())
  showId String
  seatId String
  price  Int      @default(100) // Price in cents/paise
  tier   SeatTier @default(REGULAR)

  createdAt DateTime @default(now())

  show      Show          @relation(fields: [showId], references: [id])
  seat      Seat          @relation(fields: [seatId], references: [id])
  payments  Payment[]
  bookings  BookingSeat[]
  seatHolds SeatHold[]

  @@unique([showId, seatId])
  @@index([showId])
}

////////////////////
/// SEAT HOLDS   ///
////////////////////

model SeatHold {
  id         String   @id @default(uuid())
  userId     String
  showSeatId String
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id])
  showSeat ShowSeat @relation(fields: [showSeatId], references: [id])

  @@unique([showSeatId]) // Only one hold per seat at a time
  @@index([expiresAt])
  @@index([userId])
}

////////////////////
/// BOOKINGS     ///
////////////////////

model Booking {
  id          String        @id @default(uuid())
  userId      String
  showId      String
  status      BookingStatus
  paymentRef  String
  totalAmount Int           @default(0)
  expiresAt   DateTime? // For PENDING bookings - when they auto-expire
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user     User          @relation(fields: [userId], references: [id])
  show     Show          @relation(fields: [showId], references: [id])
  payments Payment[]
  seats    BookingSeat[]

  @@unique([paymentRef])
  @@index([userId])
  @@index([showId])
  @@index([status])
  @@index([expiresAt])
}

model BookingSeat {
  id         String @id @default(uuid())
  bookingId  String
  showSeatId String

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  showSeat ShowSeat @relation(fields: [showSeatId], references: [id])

  @@unique([showSeatId])
}

////////////////////
/// PAYMENTS    ///
////////////////////

model Payment {
  id          String        @id @default(uuid())
  userId      String
  bookingId   String
  amount      Int
  status      PaymentStatus
  reference   String        @unique
  gatewayRef  String? // External gateway reference
  gatewayData String? // JSON string of gateway response
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user      User       @relation(fields: [userId], references: [id])
  booking   Booking    @relation(fields: [bookingId], references: [id])
  showSeats ShowSeat[]

  @@index([bookingId])
  @@index([reference])
}

////////////////////
/// ENUMS       ///
////////////////////

enum BookingStatus {
  PENDING // Awaiting payment
  CONFIRMED // Payment successful
  CANCELLED // User/admin cancelled
  EXPIRED // Payment timeout
  REFUNDED // Refund processed
}

enum PaymentStatus {
  INITIATED
  SUCCESS
  FAILED
  REFUNDED
}

enum SeatTier {
  REGULAR
  PREMIUM
  VIP
}
